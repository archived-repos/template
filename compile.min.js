/*! jstool-compile 2015-04-26 */
!function(a,b){"use strict";"undefined"==typeof a?"undefined"!=typeof module&&(module.exports=b()):void 0!==a.define?a.define("compile",b):void 0!==a.fn?a.fn.define("compile",b):a.compile||(a.compile=b())}(this,function(){"use strict";function a(){}function b(a){return function(b){return b instanceof a}}function c(a){return"string"==typeof a}function d(a){return new Function("model","try{ with(model) { return ("+a+") }; } catch(err) { return ''; }")}function e(a,b){if(!n(b))throw"handler should be a function";if(o(a))a.forEach(b);else if(p(a))for(var c in a)b.apply(null,[a[c],c])}function f(a,b){for(var c in b)a[c]=b[c]}function g(a){a instanceof Object&&f(this,a)}function h(a){if(!c(a))throw"template should be a string";var b=a.split(q),d=[b.shift()];a.replace(r,function(a,c,e,f,g,h){d.push(g?{cmd:"",expression:"/"}:h?{cmd:"",expression:"else"}:{cmd:e,expression:f}),d.push(b.shift())});var e=i(d,"root");return e}function i(a,b,c){b=(b||"").trim(),c=c||"";for(var d={content:[]},e="content",f=function(a){d[a]=[],e=a},g=a.shift();void 0!==g;){if("string"==typeof g)d[e].push(g);else if(p(g))if(g.cmd)switch(g.cmd){case"i18n":d[e].push(new l(g.cmd,g.expression.replace(/\/$/,"")));break;case"case":case"when":f(g.expression);break;default:d[e].push("/"===g.expression.substr(-1)?new l(g.cmd,g.expression.replace(/\/$/,"")):i(a,g.cmd,g.expression))}else switch(g.expression){case"else":case"otherwise":f("otherwise");break;case"/":return new l(b,c,d);default:d[e].push(new l("var",g.expression))}g=a.shift()}return new l(b,c,d)}function j(a,b){var d="";return n(b)?b(a):o(b)?(b.forEach(function(e){c(e)?d+=e:e instanceof l?d+=e.render(a):o(e)&&(d+=j(a,b))}),d):b}function k(a){return function(b){return j(b,a)}}function l(b,c,d){this.cmd=b,this.expression=c,this.options={content:a,otherwise:a};for(var e in d)this.options[e]=k(d[e])}function m(a){var b=h(a),c=function(a){return b.render(a)};return c.compiled=b,c}var n=b(Function),o=b(Array),p=b(Object);g.prototype.$new=function(a){var b=function(a){a instanceof Object&&f(this,a)};return b.prototype=this,new b(a)},g.prototype.$extend=function(a){return f(this,a)},g.prototype.$eval=function(a){return d(a)(this)};var q=/\$[\w\?]*{[^\}]+}|{[\$\/]}|{\:}/,r=/(\$([\w\?]*){([^\}]+)})|({[\$\/]})|({\:})/g,s=/^(.*)(\,(.*))in(.*)$/,t=/^(.*)\bin\b(.*)$/,u=function(a,b,c,d){var f,g=this,h="",i=a.$eval(b);if(o(i))f="$index";else{if(!p(i))return console.warn("can not list",i),"";f="$key"}return e(i,function(b,e){var i={};i[c]=b,i[f]=e,d&&(i[d]=e),h+=g.content(a.$new(i))}),h},v={root:function(a){return this.content(a)},"var":function(a,b){return a.$eval(b)},"if":function(a,b){return a.$eval(b)?this.content(a):this.otherwise(a)},each:function(a,b){var c;if(c=b.match(s))return u.call(this,a,c[4],c[1].trim(),c[3].trim());if(c=b.match(t))return u.call(this,a,c[2],c[1].trim());throw b+" malformed each expression"}};return v["?"]=v["if"],l.prototype.render=function(a){if(!n(v[this.cmd]))return"[command "+this.cmd+" not found]";var b=a instanceof g?a:new g(a),c=v[this.cmd].apply(this.options,[b,this.expression]);return""+j(b,c)},m.cmd=function(a,b){c(a)&&n(b)&&(v[a]=b)},m});