/*! jstool-compile 2015-04-26 */
!function(a,b){"use strict";"undefined"==typeof a?"undefined"!=typeof module&&(module.exports=b()):void 0!==a.define?a.define("compile",b):void 0!==a.fn?a.fn.define("compile",b):a.compile||(a.compile=b())}(this,function(){"use strict";function a(){}function b(a){return function(b){return b instanceof a}}function c(a){return"string"==typeof a}function d(a){return new Function("model","try{ with(model) { return ("+a+") }; } catch(err) { return ''; }")}function e(a,b){for(var c in b)a[c]=b[c]}function f(a){a instanceof Object&&e(this,a)}function g(a){if(!c(a))throw"template should be a string";var b=a.split(p),d=[b.shift()];a.replace(q,function(a,c,e,f,g,h){d.push(g?{cmd:"",expression:"/"}:h?{cmd:"",expression:"else"}:{cmd:e,expression:f}),d.push(b.shift())});var e=h(d,"root");return e}function h(a,b,c){b=(b||"").trim(),c=c||"";for(var d={content:[]},e="content",f=function(a){d[a]=[],e=a},g=a.shift();void 0!==g;){if("string"==typeof g)d[e].push(g);else if(o(g))if(g.cmd)switch(g.cmd){case"i18n":d[e].push(new k(g.cmd,g.expression.replace(/\/$/,"")));break;case"case":case"when":f(g.expression);break;default:d[e].push("/"===g.expression.substr(-1)?new k(g.cmd,g.expression.replace(/\/$/,"")):h(a,g.cmd,g.expression))}else switch(g.expression){case"else":case"otherwise":f("otherwise");break;case"/":return new k(b,c,d);default:d[e].push(new k("var",g.expression))}g=a.shift()}return"root"!==b&&console.log("something wrong in script"),new k(b,c,d)}function i(a,b){var d="";return m(b)?b(a):n(b)?(b.forEach(function(e){c(e)?d+=e:e instanceof k?d+=e.render(a):n(e)&&(d+=i(a,b))}),d):b}function j(a){return function(b){return i(b,a)}}function k(b,c,d){this.cmd=b,this.expression=c,this.options={content:a,otherwise:a};for(var e in d)this.options[e]=j(d[e])}function l(a){var b=g(a),c=function(a){return b.render(a)};return c.compiled=b,c}var m=b(Function),n=b(Array),o=b(Object);f.prototype.$new=function(a){var b=function(a){a instanceof Object&&e(this,a)};return b.prototype=this,new b(a)},f.prototype.$extend=function(a){return e(this,a)},f.prototype.$eval=function(a){return d(a)(this)};var p=/\$[\w\?]*{[^\}]+}|{[\$\/]}|{\:}/,q=/(\$([\w\?]*){([^\}]+)})|({[\$\/]})|({\:})/g;g.cmd=function(a,b){c(a)&&m(b)&&(s[a]=b)};var r=/^(.*)\bin\b(.*)$/,s={root:function(a){return this.content(a)},"var":function(a,b){return a.$eval(b)},"if":function(a,b){return a.$eval(b)?this.content(a):this.otherwise(a)},each:function(a,b){var c=this;return b.replace(r,function(b,d,e){var f={},g="",h=a.$eval(e);if(d=d.trim(),n(h))for(var i=0,j=h.length;j>i;i++)f[d]=h[i],f.$index=i,g+=c.content(a.$new(f));else if(o(h))for(var k in h)f[d]=h[k],f.$key=k,g+=c.content(a.$new(f));return g})}};return s["?"]=s["if"],k.prototype.render=function(a){if(!m(s[this.cmd]))return"[command "+this.cmd+" not found]";var b=a instanceof f?a:new f(a),c=s[this.cmd].apply(this.options,[b].concat(this.expression.split(",")));return i(b,c)},l});